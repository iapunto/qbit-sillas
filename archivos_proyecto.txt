

/* ===================== Archivo: .eslintrc.json ===================== */

{
    "env": {
      "browser": true,
      "node": true,
      "es2021": true
    },
    "extends": [
      "eslint:recommended",
      "plugin:@typescript-eslint/recommended",
      "plugin:builderbot/recommended"
    ],
    "parser": "@typescript-eslint/parser",
    "parserOptions": {
      "ecmaVersion": "latest",
      "sourceType": "module"
    },
    "plugins": ["@typescript-eslint", "builderbot"],
    "rules": {
      "@typescript-eslint/no-explicit-any": "off",
      "@typescript-eslint/no-unused-vars": "off",
      "@typescript-eslint/ban-ts-comment": "off",
      "@typescript-eslint/ban-types": "off",
      "no-unsafe-optional-chaining": "off"
    }
  }
  

/* ===================== Archivo: nodemon.json ===================== */

{
    "watch": ["src"],
    "ext": "ts",
    "ignore": [
      "**/*.test.ts",
      "**/*.spec.ts"
  ],
    "delay": "3",
    "execMap": {
      "ts": "tsx"
    }
  }

/* ===================== Archivo: package.json ===================== */

{
  "name": "base-bailey-json",
  "version": "1.0.0",
  "description": "",
  "main": "dist/app.js",
  "type": "module",
  "scripts": {
    "start": "node ./dist/app.js",
    "lint": "eslint . --no-ignore",
    "dev": "npm run lint && nodemon ./src/app.ts",
    "build": "npx rollup -c"
  },
  "keywords": [],
  "dependencies": {
    "@builderbot-plugins/gemini-layer": "^0.0.2",
    "@builderbot-plugins/url-to-base64": "^1.0.0",
    "@builderbot/bot": "1.2.5",
    "@builderbot/provider-meta": "1.2.5",
    "@google/generative-ai": "^0.24.0",
    "@langchain/core": "^0.3.48",
    "@langchain/google-genai": "^0.2.4",
    "date-fns": "^4.1.0",
    "date-fns-tz": "^3.2.0"
  },
  "devDependencies": {
    "@types/dotenv": "^8.2.0",
    "@types/node": "^20.11.30",
    "@typescript-eslint/eslint-plugin": "^7.2.0",
    "@typescript-eslint/parser": "^7.4.0",
    "eslint": "^8.52.0",
    "eslint-plugin-builderbot": "latest",
    "nodemon": "^3.1.0",
    "rollup": "^4.10.0",
    "rollup-plugin-typescript2": "^0.36.0",
    "tsx": "^4.7.1",
    "typescript": "^5.4.3"
  },
  "author": "",
  "license": "ISC"
}


/* ===================== Archivo: src\app.ts ===================== */

import { createBot, createFlow } from "@builderbot/bot";
import { provider } from "~/provider";
import { adapterDB } from "~/database";
import welcomeFlow from "~/flows/welcome.flow";
import { config } from "~/config";
import sellerFlow from "~/flows/seller.flow";

const PORT = config.port;

const main = async () => {
  console.log("Iniciando la aplicaci√≥n..."); // Log al inicio
  const adapterFlow = createFlow([welcomeFlow, sellerFlow]);
  const { httpServer } = await createBot({
    flow: adapterFlow,
    provider: provider,
    database: adapterDB,
  });
  httpServer(+PORT);
  console.log(`Servidor escuchando en el puerto ${PORT}`); // Log del puerto
};

main();


/* ===================== Archivo: src\config\index.ts ===================== */

// src/config.ts

import dotenv from "dotenv";

// Cargar las variables de entorno desde el archivo .env
dotenv.config();

// Lista de variables requeridas
const requiredEnvVars = [
  "JWT_TOKEN",
  "NUMBER_ID",
  "VERIFY_TOKEN",
  "VERSION",
  "GOOGLE_API_KEY",
  "PORT",
];

// Validar que todas las variables requeridas est√©n definidas
for (const varName of requiredEnvVars) {
  if (!process.env[varName]) {
    throw new Error(`La variable de entorno ${varName} no est√° definida.`);
  }
}

// Exportar las variables de entorno como constantes
export const config = {
  jwtToken: process.env.JWT_TOKEN!,
  numberId: process.env.NUMBER_ID!,
  verifyToken: process.env.VERIFY_TOKEN!,
  version: process.env.VERSION!,
  googleApiKey: process.env.GOOGLE_API_KEY!,
  port: parseInt(process.env.PORT!, 10),
};


/* ===================== Archivo: src\data\products.ts ===================== */

export const productList = [
  {
    name: "Silla Ergon√≥mica Sihoo Doro S300 - Gris",
    price: "$3.550.000",
    link: "https://sillas.com.co/tienda/silla-sihoo-doro-s300/?attribute_color=Gris",
  },
  {
    name: "Silla Ergon√≥mica Sihoo Doro S300 - Negro",
    price: "$3.465.000",
    link: "https://sillas.com.co/tienda/silla-sihoo-doro-s300/?attribute_color=Negro",
  },
  {
    name: "Silla de Oficina Ergon√≥mica Sihoo M102",
    price: "$683.000",
    link: "https://sillas.com.co/tienda/silla-de-oficina-ergonomica-sihoo-m102/",
  },
  {
    name: "Silla Ergon√≥mica Sihoo Presidencial Star V1",
    price: "$2.250.000",
    link: "https://sillas.com.co/tienda/silla-sihoo-presidencial-star-v1/",
  },
  {
    name: "Silla Ergon√≥mica Sihoo Doro C300 Pro",
    price: "$2.650.000 ‚Äì $2.735.000",
    link: "https://sillas.com.co/tienda/silla-ergonomica-sihoo-doro-c300-pro/",
  },
  {
    name: "Silla Ergon√≥mica Sihoo Ergomax M97B",
    price: "$2.600.000",
    link: "https://sillas.com.co/tienda/silla-ergonomica-sihoo-ergomax-m97b/",
  },
  {
    name: "SILLA GERENCIAL DELPHI ALUMINIO",
    price: "$680.000",
    link: "https://sillas.com.co/tienda/silla-gerencial-delphi-aluminio/",
  },
  {
    name: "SILLA GERENCIAL DELPHI BASE NEGRA",
    price: "$600.000",
    link: "https://sillas.com.co/tienda/silla-gerencial-delphi-base-negra/",
  },
  {
    name: "SILLA GERENCIAL NEFI GRIS",
    price: "$1.900.000",
    link: "https://sillas.com.co/tienda/silla-gerencial-nefi-gris/",
  },
  {
    name: "SILLA OPERATIVA DELPHI BASE NEGRA",
    price: "$450.000",
    link: "https://sillas.com.co/tienda/silla-operativa-delphi-base-negra/",
  },
  {
    name: "SILLA OPERATIVA DELPHI CROMADA",
    price: "$485.000",
    link: "https://sillas.com.co/tienda/silla-operativa-delphi-cromada/",
  },
  {
    name: "SILLA PRESIDENCIAL MANHATTAN ECO",
    price: "$1.700.000",
    link: "https://sillas.com.co/tienda/silla-presidencial-manhattan-eco/",
  },
  {
    name: "SILLA PRESIDENCIAL NIZA",
    price: "$465.000",
    link: "https://sillas.com.co/tienda/silla-presidencial-niza/",
  },
  {
    name: "SILLA PRESIDENCIAL OSAKA",
    price: "$818.678",
    link: "https://sillas.com.co/tienda/silla-presidencial-osaka/",
  },
  {
    name: "SILLA SIHOO S50",
    price: "$1.850.000 (Agotado)",
    link: "https://sillas.com.co/tienda/silla-sihoo-s50/",
  },
  {
    name: "SILLA THINK GERENTE NEGRA",
    price: "$750.000",
    link: "https://sillas.com.co/tienda/silla-think-gerente-negra/",
  },
];


/* ===================== Archivo: src\data\services.ts ===================== */

export const servicesData = [
  {
    name: "Marketing Digital con IA",
    description:
      "Implementamos estrategias innovadoras de marketing digital optimizadas con inteligencia artificial para maximizar tu presencia online y aumentar tus conversiones.",
    benefits: [
      "SEO avanzado (On-Page y Off-Page)",
      "Campa√±as publicitarias en Google Ads, Meta Ads, LinkedIn Ads y TikTok Ads",
      "Generaci√≥n de contenido optimizado para SEO",
      "Gesti√≥n estrat√©gica de redes sociales",
    ],
  },
  {
    name: "Dise√±o y Desarrollo Web",
    description:
      "Creamos sitios web profesionales, personalizados y optimizados para mejorar la experiencia del usuario y aumentar las conversiones.",
    benefits: [
      "Dise√±o UX/UI enfocado en la conversi√≥n",
      "Desarrollo de tiendas online con funcionalidades avanzadas",
      "Optimizaci√≥n de velocidad y rendimiento",
      "Mantenimiento t√©cnico continuo",
    ],
  },
  {
    name: "Chatbots Inteligentes",
    description:
      "Dise√±amos e implementamos chatbots automatizados que mejoran la atenci√≥n al cliente y optimizan la gesti√≥n de leads.",
    benefits: [
      "Automatizaci√≥n de respuestas frecuentes",
      "Integraci√≥n con sistemas CRM",
      "Flujos de conversaci√≥n personalizados",
      "Mejora en la satisfacci√≥n del cliente",
    ],
  },
  {
    name: "Desarrollo de Aplicaciones M√≥viles",
    description:
      "Desarrollamos aplicaciones m√≥viles intuitivas y funcionales para iOS y Android, adaptadas a las necesidades de tu negocio.",
    benefits: [
      "Desarrollo h√≠brido y nativo",
      "Notificaciones push y autenticaci√≥n de usuarios",
      "Integraci√≥n con sistemas empresariales (CRMs, ERPs, APIs)",
      "Optimizaci√≥n ASO para mayor visibilidad",
    ],
  },
  {
    name: "Implementaci√≥n de Odoo ERP",
    description:
      "Configuramos y personalizamos Odoo ERP para gestionar de manera integral todos los procesos de tu empresa.",
    benefits: [
      "Configuraci√≥n de m√≥dulos b√°sicos (CRM, ventas, facturaci√≥n, contabilidad)",
      "Personalizaci√≥n avanzada seg√∫n tus necesidades",
      "Automatizaci√≥n de flujos de trabajo",
      "Capacitaci√≥n y soporte t√©cnico prioritario",
    ],
  },
  {
    name: "Optimizaci√≥n y Conversi√≥n (CRO)",
    description:
      "Analizamos y optimizamos tu sitio web para aumentar la tasa de conversi√≥n y mejorar la experiencia del usuario.",
    benefits: [
      "Pruebas A/B para mejorar rendimientos",
      "An√°lisis de embudos de conversi√≥n",
      "Pruebas de usabilidad con usuarios reales",
      "Mejoras en la interfaz y navegaci√≥n",
    ],
  },
  {
    name: "Automatizaci√≥n Inteligente",
    description:
      "Dise√±amos flujos de trabajo automatizados para aumentar la eficiencia operativa y reducir costos.",
    benefits: [
      "Automatizaci√≥n de procesos repetitivos",
      "Integraci√≥n de herramientas y sistemas",

      "Sincronizaci√≥n de datos entre plataformas",
      "Soluciones personalizadas para tu negocio",
    ],
  },
  {
    name: "Email Marketing",
    description:
      "Creamos campa√±as de email marketing efectivas para conectar con tu audiencia y fidelizar clientes.",
    benefits: [
      "Dise√±o de plantillas atractivas y optimizadas",
      "Automatizaci√≥n de flujos de email",
      "Segmentaci√≥n y personalizaci√≥n avanzada",
      "Mejora en la tasa de apertura y clics",
    ],
  },
  {
    name: "Consultor√≠a y Estrategia Digital",
    description:
      "Ofrecemos asesoramiento experto para planificar y ejecutar estrategias digitales que impulsen el crecimiento de tu negocio.",
    benefits: [
      "Auditor√≠as digitales completas",
      "Planificaci√≥n estrat√©gica de marketing digital",
      "Capacitaci√≥n en IA y tecnolog√≠a avanzada",
      "Asesoramiento personalizado",
    ],
  },
];


/* ===================== Archivo: src\database\index.ts ===================== */

import { MemoryDB as Database } from "@builderbot/bot";

export const adapterDB = new Database();


/* ===================== Archivo: src\flows\seller.flow.ts ===================== */

import { addKeyword, EVENTS } from "@builderbot/bot";
import GeminiService from "../services/geminiService";
import { getHistoryParse, handleHistory } from "../utils/handledHistory";
import { servicesData } from "../data/services";
// Aseg√∫rate de tener tus servicios aqu√≠
import { generateTimer } from "../utils/generateTimer";
// Importa la funci√≥n para generar el tiempo de espera

const PROMPT_SELLER = `
    Eres qBit, un asistente de IA experto en comprender las intenciones de los usuarios y responder preguntas sobre IA Punto.
    ### INSTRUCCIONES IMPORTANTES:
    - Si el usuario env√≠a un saludo inicial (como "hola", "buenas", etc.), responde con: 
      "¬°Hola! Soy qBit, tu asistente virtual de IA Punto Soluciones Tecnol√≥gicas. üòä ¬øEn qu√© puedo ayudarte hoy?".
    - Si el usuario ya ha recibido el saludo inicial y sigue enviando saludos repetidos o mensajes sin intenci√≥n clara, responde con:
      "Lo siento, no puedo entender lo que me dices. ¬øPuedes ser m√°s espec√≠fico? üòï".
    - Si el historial de conversaci√≥n muestra que el usuario ha interactuado contigo varias veces (m√°s de 5 mensajes) y sigue sin proporcionar una intenci√≥n clara, responde con:
      "He notado que has estado saludando varias veces. üòä ¬øTe gustar√≠a saber m√°s sobre nuestros servicios o tienes alguna pregunta espec√≠fica?".
    - Si el usuario tiene una pregunta general, resp√≥ndele utilizando la informaci√≥n de los servicios.
    - Si no reconoces una intenci√≥n clara, responde con:
      "Lo siento, no puedo entender la intenci√≥n del usuario. üòï ¬øPuedes ser m√°s espec√≠fico?".
    - Si existe un inter√©s en un servicio y/o producto o solicitan informaci√≥n adicional que no tengas, ofrece el Agendar una reuni√≥n.
    - Somos facturadores electr√≥nicos, emitimos factura electronica en Colombia. Tambi√©n integramos la facturaci√≥n electronica a sistemas existentes.
    en este caso se debe interpretar bien lo que el usuario esta preguntando si las emitimos legalmente para cumplir con las normativas DIAN o las integramos en su sistema para que ellos emitan facturas.
    ### INFORMACI√ìN SOBRE IA PUNTO:
    Somos IA Punto, donde cada byte cuenta y cada idea es un rayo de innovaci√≥n.
    Somos m√°s que una agencia de marketing digital; somos arquitectos de experiencias digitales, creadores de conexiones impactantes entre marcas y audiencias.
    En IA Punto, desafiamos las normas y abrazamos la locura creativa, porque creemos que la innovaci√≥n nace de la libertad.
    Lo Que Nos Define:
    En IA Punto, la inteligencia artificial no solo est√° en nuestro nombre, est√° en nuestro ADN.
    Cada estrategia es un algoritmo de creatividad, cada campa√±a es un experimento de innovaci√≥n.
    Somos impulsados por la curiosidad y alimentamos nuestra creatividad con el combustible de la libertad.
    Nuestro Compromiso:
    M√°s all√° de los servicios, nos comprometimos a ser tus aliados en el viaje digital.
    Tu √©xito es nuestro √©xito, y nos embarcamos en cada proyecto con pasi√≥n y determinaci√≥n.
    Aqu√≠, la locura es bienvenida, la creatividad es esencial, y cada desaf√≠o es una oportunidad de brillar.
    Principios:
    * Innovaci√≥n Constante
    * Colaboraci√≥n sin L√≠mites
    * Transparencia Total
    * Pasi√≥n Imparable

    ¬øPor qu√© trabajar con nosotros?
    * Innovaci√≥n sin L√≠mites
    * Equipo Apasionado
    * Transparencia Total
    * Resultados Tangibles
    * Experiencia Personalizada
    * Compromiso Sostenible

    Horario de atenci√≥n: lunes a viernes, de 09:00 a 12:00 y de 13:00 a 17:00.
    Sitio web: www.iapunto.com
    Correo: hola@iapunto.com
    Tel√©fono: +57 316 376 9935

    ### HISTORIAL DE LA CONVERSACI√ìN:
    {HISTORY}

    ### MENSAJE DEL USUARIO:
    {MESSAGE}

    ### Servicios de IA Punto:
    {SERVICES}

    Responde de forma concisa y amigable siguiendo las instrucciones anteriores.
`;

// Funci√≥n para generar el prompt din√°mico
const generatePromptSeller = (history: string, message: string) => {
  const services = JSON.stringify(servicesData); // Convierte los servicios a JSON
  return PROMPT_SELLER.replace("{HISTORY}", history)
    .replace("{MESSAGE}", message)
    .replace("{SERVICES}", services);
};

const sellerFlow = addKeyword(EVENTS.ACTION).addAction(
  async (ctx, { state, flowDynamic, gotoFlow }) => {
    try {
      console.log("Recibido mensaje del usuario:", ctx.body); // Log de recepci√≥n
      const geminiServices = new GeminiService();
      const history = getHistoryParse(state);
      console.log("Historial de conversaci√≥n:", history);

      // Genera el prompt din√°mico
      const prompt = generatePromptSeller(history, ctx.body);
      console.log("Prompt generado:", prompt); // Log del prompt

      // Obtiene la respuesta del modelo
      const result = await geminiServices.generateContent(prompt);
      const response = result.response.text();
      console.log("Respuesta del modelo:", response); // Log de la respuesta

      // Almacena la respuesta en el historial
      await handleHistory({ content: response, role: "assistant" }, state);

      // Divide la respuesta en fragmentos para enviarlos gradualmente
      const chunks = response.split(/(?<!\d)\.\s+/g);
      for (const chunk of chunks) {
        // Simular un retraso de 5 segundos para procesar la solicitud

        await flowDynamic([
          { body: chunk.trim(), delay: generateTimer(2000, 3500) },
        ]);
        console.log("Mensaje enviado al usuario:", chunk.trim()); // Log de env√≠o
      }
    } catch (error: any) {
      console.error("Error en el flujo 'sellerFlow':", error.message || error);
      await flowDynamic(
        "Lo siento, no puedo generar una respuesta en este momento. üòï"
      );
    }
  }
);

export default sellerFlow;


/* ===================== Archivo: src\flows\welcome.flow.ts ===================== */

import { addKeyword, EVENTS } from "@builderbot/bot";
import intentFlow from "~/layers";
import conversationalLayer from "~/layers/conversational.layer";

const welcomeFlow = addKeyword(EVENTS.WELCOME)
  .addAction(conversationalLayer)
  .addAction(intentFlow);

export default welcomeFlow;


/* ===================== Archivo: src\layers\conversational.layer.ts ===================== */

import { BotContext, BotMethods } from "@builderbot/bot/dist/types";
import { handleHistory } from "../utils/handledHistory";

/**
 * Stores all user messages in the `state`.
 *
 * @param ctx - Bot context, including the user's message.
 * @param methods - Bot methods, such as `state`.
 */
export default async (
  ctx: BotContext,
  { state }: BotMethods
): Promise<void> => {
  const { body } = ctx;

  try {
    // Validate that the message is not empty
    if (!body || body.trim().length === 0) {
      console.warn("The user's message is empty or contains only whitespace.");
      return;
    }

    // Store the message in the history
    await handleHistory({ content: body.trim(), role: "user" }, state);
    console.log("Mensaje guardado en el historial:", body.trim()); // Log para verificar el almacenamiento
  } catch (error) {
    console.error("Error en conversationalLayer:", error);
    throw error; // Propagate the error to be handled at higher levels if necessary
  }
};


/* ===================== Archivo: src\layers\index.ts ===================== */

import { addKeyword, EVENTS } from "@builderbot/bot";
import MainLayer from "./main.layer";
import { BotContext, BotMethods } from "@builderbot/bot/dist/types";
import sellerFlow from "../flows/seller.flow";

const intentions = new MainLayer();

const intentFlow = addKeyword(EVENTS.ACTION).addAction(
  async (ctx: BotContext, { gotoFlow, flowDynamic, state }: BotMethods) => {
    try {
      // Obtener el mensaje del usuario
      const message = ctx.body;
      console.log("Mensaje recibido: ", message);

      // Determinar la intenci√≥n del usuario
      const intention = await intentions.determineIntent(message, state);
      console.log("Intenci√≥n detectada: ", intention);

      // Log adicional para debug
      console.log("Tipo de dato de intenci√≥n:", typeof intention);
      console.log("Valor exacto de intenci√≥n:", `"${intention}"`);

      console.log(
        `Comparando: "${intention.trim().toUpperCase()}" con "HABLAR"`
      );
      // Seleccionar la acci√≥n adecuada seg√∫n la intenci√≥n del usuario
      if (intention && intention.trim().toUpperCase() === "HABLAR") {
        console.log("Redirigiendo a sellerFlow");
        return gotoFlow(sellerFlow);
      } else {
        console.log("No se reconoci√≥ la intenci√≥n, enviando mensaje de error");
        await flowDynamic(
          "Lo siento, no pude entender tu mensaje. ¬øPodr√≠as reformularlo?"
        );
      }
    } catch (error) {
      console.error(error);
    }
  }
);

export default intentFlow;


/* ===================== Archivo: src\layers\main.layer.ts ===================== */

import GeminiService from "~/services/geminiService";
import { getHistoryParse } from "~/utils/handledHistory";

class MainLayer {
  // Intention detection
  async determineIntent(message: string, state: any): Promise<string> {
    const ia = new GeminiService();
    const history = getHistoryParse(state);

    const prompt = `Eres un asistente de IA experto en comprender las intenciones de los usuarios.
    Tu tarea es analizar el mensaje del usuario y determinar su intenci√≥n principal.
    ### Historial de Conversaci√≥n ###
    ${history}

    ### Mensaje del usuario: ###
    ${message}

    Posibles acciones a realizar:

    HABLAR: Esta acci√≥n se debe realizar cuando el cliente desea hacer una pregunta o necesita m√°s informaci√≥n sobre IA Punto o sus servicios.
    Objetivo:

    Comprender la intenci√≥n del cliente en el contexto de la conversaci√≥n con IA Punto y seleccionar 
    la acci√≥n m√°s adecuada en respuesta a su declaraci√≥n.
    Consideraciones:

    * IA Punto ofrece servicios de Marketing y desarrollo web/m√≥vil impulsadas por la Inteligencia Artificial.
    * El objetivo principal del bot es guiar al cliente, identificar sus necesidades y una vez identificada una intenci√≥n o inter√©s en un producto/servicio persuadir para que agende una reuni√≥n con un asesor.
    * El bot debe ser amigable, profesional y servicial.

    ### Instrucciones ###
      Analiza el mensaje del usuario y selecciona la acci√≥n m√°s adecuada.
    Respuesta ideal (HABLAR):`;

    try {
      const result = await ia.generateContent(prompt);
      let intention = result.response.text().trim();
      // Ajusta seg√∫n la estructura de la respuesta

      console.log("Respuesta cruda del modelo:", intention);
      // Extraer solo la primera palabra (la intenci√≥n principal)
      const firstWordMatch = intention.match(/^\w+/);
      if (!firstWordMatch) {
        console.warn("No se pudo extraer la intenci√≥n principal del modelo.");
        return "UNKNOWN";
      }

      intention = firstWordMatch[0].toUpperCase();

      console.log("Intenci√≥n extra√≠da:", intention);
      // Validar que la intenci√≥n sea una de las opciones v√°lidas
      const validIntents = ["HABLAR"];
      if (!validIntents.includes(intention)) {
        console.warn("Intenci√≥n no v√°lida detectada:", intention);
        return "UNKNOWN"; // Devuelve una intenci√≥n desconocida si no coincide
      }

      return intention;
    } catch (error: any) {
      console.error(
        "Error al determinar la intenci√≥n:",
        error.message || error
      );
      throw error; // Propaga el error para manejarlo en niveles superiores
    }
  }
}

export default MainLayer;


/* ===================== Archivo: src\provider\index.ts ===================== */

// src/provider.ts

import { createProvider } from "@builderbot/bot";
import { MetaProvider } from "@builderbot/provider-meta";
import { config } from "~/config";

export const provider = createProvider(MetaProvider, {
  jwtToken: config.jwtToken,
  numberId: config.numberId,
  verifyToken: config.verifyToken,
  version: config.version,
});


/* ===================== Archivo: src\services\geminiService.ts ===================== */

import { GoogleGenerativeAI } from "@google/generative-ai";
import { config } from "../config";

class GeminiService {
  private genAI: GoogleGenerativeAI;
  private model: any; // Puedes especificar el tipo m√°s adelante si es necesario

  constructor() {
    this.genAI = new GoogleGenerativeAI(config.googleApiKey as string);
    this.model = this.genAI.getGenerativeModel({ model: "gemini-pro" });
  }

  async generateContent(prompt: string): Promise<any> {
    try {
      const result = await this.model.generateContent(prompt);
      const response = result.response;

      if (!response || !response.text) {
        console.warn("Respuesta del modelo vac√≠a o sin texto.");
        return {
          response: { text: () => "Lo siento, no obtuve una respuesta clara." },
        };
      }

      return { response };
    } catch (error: any) {
      console.error("Error al generar contenido:", error.message || error);
      // Considera lanzar el error nuevamente o manejarlo de otra manera
      // dependiendo de tus necesidades
      throw error;
    }
  }
}

export default GeminiService;


/* ===================== Archivo: src\tests\test_gemini.ts ===================== */

import { GoogleGenerativeAI } from "@google/generative-ai";
import dotenv from "dotenv";

dotenv.config(); // Carga variables de entorno desde .env

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY!);
const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

async function testGemini() {
  try {
    const prompt = "Explica c√≥mo funciona la energ√≠a solar en 3 puntos clave";
    const result = await model.generateContent(prompt);
    const response = await result.response;
    console.log("Respuesta de Gemini:");
    console.log(response.text());
  } catch (error) {
    console.error("Error al usar Gemini:", error);
  }
}

testGemini();


/* ===================== Archivo: src\utils\generateTimer.ts ===================== */

/**
 * Genera un n√∫mero entero aleatorio entre min y max (ambos incluidos).
 * @param min - El valor m√≠nimo del rango.
 * @param max - El valor m√°ximo del rango.
 * @returns Un n√∫mero entero aleatorio dentro del rango [min, max].
 * @throws Error si min es mayor que max.
 */
function generateTimer(min: number, max: number): number {
  // Validar que min sea menor o igual que max
  if (min > max) {
    throw new Error("El valor de 'min' debe ser menor o igual que 'max'.");
  }

  // Generar un n√∫mero aleatorio en el rango [min, max]
  const numSal = Math.random(); // Genera un n√∫mero entre 0 (incluido) y 1 (excluido)
  const numeroAleatorio = Math.floor(numSal * (max - min + 1)) + min;

  return numeroAleatorio;
}

export { generateTimer };


/* ===================== Archivo: src\utils\getCurrentDateTime.ts ===================== */

import { toZonedTime } from "date-fns-tz";
import { addDays, parse, format } from "date-fns";

/**
 * Obtiene la fecha y hora actuales en formato yyyy/MM/dd HH:mm:ss.
 * @returns Fecha y hora actuales.
 */
export const getCurrentDateTime = (): string => {
  return format(new Date(), "yyyy/MM/dd HH:mm:ss");
};

/**
 * Agrega minutos a una fecha dada.
 * @param date - La fecha inicial.
 * @param minutes - Los minutos a agregar.
 * @returns La nueva fecha.
 */
export const addMinutesToDate = (date: Date, minutes: number): Date => {
  return new Date(date.getTime() + minutes * 60000);
};

/**
 * Convierte una expresi√≥n relativa en una fecha absoluta.
 * @param input - La entrada del usuario (por ejemplo, "ma√±ana a las 4pm").
 * @param currentDate - La fecha y hora actuales.
 * @returns Una fecha absoluta en formato yyyy/MM/dd HH:mm:ss.
 */
export const parseRelativeDate = (input: string, currentDate: Date): string => {
  const lowerInput = input.toLowerCase();

  // Manejar "ma√±ana"
  if (lowerInput.includes("ma√±ana")) {
    const timeMatch = lowerInput.match(/(\d{1,2}(?:am|pm))/);
    if (timeMatch) {
      const time = timeMatch[0];
      const parsedTime = parse(time, "h:mma", currentDate);
      const tomorrow = addDays(currentDate, 1);
      return format(
        new Date(
          tomorrow.getFullYear(),
          tomorrow.getMonth(),
          tomorrow.getDate(),
          parsedTime.getHours(),
          parsedTime.getMinutes()
        ),
        "yyyy/MM/dd HH:mm:ss"
      );
    }
  }

  // Manejar d√≠as espec√≠ficos (por ejemplo, "el jueves")
  const daysOfWeek = [
    "domingo",
    "lunes",
    "martes",
    "mi√©rcoles",
    "jueves",
    "viernes",
    "s√°bado",
  ];
  for (let i = 0; i < daysOfWeek.length; i++) {
    if (lowerInput.includes(daysOfWeek[i])) {
      const timeMatch = lowerInput.match(/(\d{1,2}(?:am|pm))/);
      if (timeMatch) {
        const time = timeMatch[0];
        const parsedTime = parse(time, "h:mma", currentDate);
        const currentDay = currentDate.getDay();
        const targetDay = i;
        let daysToAdd = targetDay - currentDay;
        if (daysToAdd <= 0) daysToAdd += 7; // Asegura que sea en el futuro
        const targetDate = addDays(currentDate, daysToAdd);
        return format(
          new Date(
            targetDate.getFullYear(),
            targetDate.getMonth(),
            targetDate.getDate(),
            parsedTime.getHours(),
            parsedTime.getMinutes()
          ),
          "yyyy/MM/dd HH:mm:ss"
        );
      }
    }
  }

  // Si no se encuentra una coincidencia, lanzar un error
  throw new Error("No se pudo interpretar la fecha relativa.");
};


/* ===================== Archivo: src\utils\handledHistory.ts ===================== */

import { BotStateStandAlone } from "@builderbot/bot/dist/types";
export type History = { role: "user" | "assistant"; content: string };

// Esta agrega un nuevo mensaje al historial de conversaci√≥n
const handleHistory = async (inside: History, _state: BotStateStandAlone) => {
  const history = _state.get<History[]>("history") ?? [];
  history.push(inside);
  await _state.update({ history });
};

// Recupera (k) mensajes del historial de conversaci√≥n
const getHistory = (_state: BotStateStandAlone, k = 15) => {
  const history = _state.get<History[]>("history") ?? [];
  const limitHistory = history.slice(-k);
  return limitHistory;
};

// Convierte el historial en un formato legible (cadena de texto).
const getHistoryParse = (_state: BotStateStandAlone, k = 15): string => {
  const history = _state.get<History[]>("history") ?? [];
  const limitHistory = history.slice(-k);
  return limitHistory.reduce((prev, current) => {
    const msg =
      current.role === "user"
        ? `Customer: "${current.content}"`
        : `\nSeller: "${current.content}"\n`;
    prev += msg;
    return prev;
  }, ``);
};

// Limpia el historial de conversaci√≥n
const clearHistory = async (_state: BotStateStandAlone) => {
  _state.clear();
};

export { handleHistory, getHistory, getHistoryParse, clearHistory };


/* ===================== Archivo: src\utils\logger.ts ===================== */

// src/utils/logger.ts

export const logger = {
  info: (...args: any[]) => console.info("[INFO]", ...args),
  debug: (...args: any[]) => console.debug("[DEBUG]", ...args),
  error: (...args: any[]) => console.error("[ERROR]", ...args),
};


/* ===================== Archivo: tsconfig.json ===================== */

{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ES2022",
    "declaration": false,
    "declarationMap": false,
    "moduleResolution": "node",
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "sourceMap": false,
    "outDir": "./dist",
    "baseUrl": "./",
    "rootDir": "./",
    "incremental": true,
    "skipLibCheck": true,
    "resolveJsonModule": true,
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true,
    "paths": {
      "~/*": ["./src/*"]
    }
  },
  "include": ["**/*.js", "**/*.ts"],
  "exclude": [
    "node_modules",
    "dist",
    "**/*.test.ts",
    "**/*.spec.ts",
    "**e2e**",
    "**mock**"
  ]
}
